<!DOCTYPE html>
<html>
<head>
    <title>Hattie AI - SignalR Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; padding: 0 1rem; }
        #chat-box { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 1rem; margin-bottom: 1rem; background: #f9f9f9; }
        .message { margin-bottom: 0.5rem; }
        .user { color: blue; font-weight: bold; }
        .ai { color: green; font-weight: bold; }
        .system { color: gray; font-style: italic; }
        .controls { display: flex; gap: 10px; }
        input[type="text"] { flex-grow: 1; padding: 0.5rem; }
        button { padding: 0.5rem 1rem; cursor: pointer; }
    </style>
</head>
<body>
    <h1>SignalR Chat Test</h1>
    
    <div class="controls" style="margin-bottom: 1rem;">
        <label>Tenant ID: <input type="text" id="tenantId" value="client-a" /></label>
        <button onclick="connect()">Connect</button>
    </div>

    <div id="chat-box"></div>

    <div class="controls">
        <input type="text" id="messageInput" placeholder="Type a message..." disabled />
        <button id="sendButton" onclick="sendMessage()" disabled>Send</button>
    </div>

    <script>
        let connection;
        let currentSessionId = null;
        let currentAiMessageDiv = null;

        async function connect() {
            if (window.location.protocol === 'file:') {
                alert("ERROR: You cannot run this file directly from your computer.\n\nPlease open it via the API URL: https://localhost:7157/chat-test.html");
                return;
            }

            const tenantId = document.getElementById("tenantId").value;
            if (!tenantId) return alert("Enter Tenant ID");

            connection = new signalR.HubConnectionBuilder()
                .withUrl(`/hattieHub?tenantId=${tenantId}`)
                .build();

            connection.on("ReceiveSessionId", (sessionId) => {
                currentSessionId = sessionId;
                log("System", `Session Created: ${sessionId}`, "system");
            });

            connection.on("ReceiveMessageStart", () => {
                currentAiMessageDiv = document.createElement("div");
                currentAiMessageDiv.className = "message";
                currentAiMessageDiv.innerHTML = `<span class="ai">AI:</span> `;
                document.getElementById("chat-box").appendChild(currentAiMessageDiv);
            });

            connection.on("ReceiveMessageChunk", (chunk) => {
                if (currentAiMessageDiv) {
                    currentAiMessageDiv.innerHTML += chunk;
                    scrollToBottom();
                }
            });

            connection.on("ReceiveMessageEnd", () => {
                currentAiMessageDiv = null;
                log("System", "Response Complete", "system");
            });

            connection.on("ReceiveError", (error) => {
                log("Error", error, "system");
            });

            try {
                await connection.start();
                log("System", "Connected!", "system");
                document.getElementById("messageInput").disabled = false;
                document.getElementById("sendButton").disabled = false;
            } catch (err) {
                log("Error", err.toString(), "system");
            }
        }

        async function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value;
            if (!message) return;

            log("User", message, "user");
            input.value = "";

            try {
                // Send message with session ID (if we have one)
                await connection.invoke("SendMessage", message, currentSessionId);
            } catch (err) {
                log("Error", err.toString(), "system");
            }
        }

        function log(sender, text, className) {
            const box = document.getElementById("chat-box");
            const div = document.createElement("div");
            div.className = "message";
            div.innerHTML = `<span class="${className}">${sender}:</span> ${text}`;
            box.appendChild(div);
            scrollToBottom();
        }

        function scrollToBottom() {
            const box = document.getElementById("chat-box");
            box.scrollTop = box.scrollHeight;
        }
    </script>
</body>
</html>
