@page "/knowledge-base"
@using HattieAI.Domain.Entities
@using HattieAI.Infrastructure.Persistence
@using HattieAI.Infrastructure.Documents
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize]
@inject IDbContextFactory<HattieDbContext> DbFactory
@inject DocumentBroker DocumentBroker
@rendermode InteractiveServer

<h3>Knowledge Base Management</h3>

<div class="mb-3">
    <label class="form-label">Select Client</label>
    <select class="form-select" @bind="selectedTenantId">
        <option value="">-- Select Client --</option>
        @foreach (var tenant in tenants)
        {
            <option value="@tenant.Id">@tenant.Name</option>
        }
    </select>
</div>

<div class="mb-3">
    <label class="form-label">Upload PDF Knowledge Base</label>
    <InputFile OnChange="HandleFileSelected" />
</div>

<div class="mb-3">
    <label class="form-label">Or Add Raw Text</label>
    <textarea class="form-control mb-2" rows="5" @bind="rawTextToAdd" placeholder="Enter text to append to knowledge base..."></textarea>
    <button class="btn btn-primary" @onclick="AppendText" disabled="@(string.IsNullOrWhiteSpace(rawTextToAdd) || string.IsNullOrEmpty(selectedTenantId))">Append Text</button>
</div>

@if (isProcessing)
{
    <div class="alert alert-info">Processing PDF...</div>
}

@code {
    private List<Tenant> tenants = new();
    private string selectedTenantId = string.Empty;
    private string rawTextToAdd = string.Empty;
    private IBrowserFile? uploadedFile;
    private bool showSuccess = false;
    private bool isProcessing = false;

    protected override async Task OnInitializedAsync()
    {
        // We need to fetch all tenants. 
        // If Global Query Filter is active and we are "Admin" (null tenantId), we need to make sure we can see all.
        using var context = DbFactory.CreateDbContext();
        tenants = await context.Tenants.IgnoreQueryFilters().ToListAsync();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        if (string.IsNullOrEmpty(selectedTenantId)) return;

        isProcessing = true;
        showSuccess = false;

        try
        {
            var file = e.File;
            using var stream = file.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024); // 10MB limit
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            memoryStream.Position = 0;

            var text = DocumentBroker.ExtractText(memoryStream);

            await AppendToKnowledgeBase(text);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task AppendText()
    {
        if (string.IsNullOrWhiteSpace(rawTextToAdd) || string.IsNullOrEmpty(selectedTenantId)) return;
        
        isProcessing = true;
        showSuccess = false;

        try
        {
            await AppendToKnowledgeBase(rawTextToAdd);
            rawTextToAdd = ""; // Clear input
        }
        finally
        {
            isProcessing = false;
        }
    }

    private async Task AppendToKnowledgeBase(string text)
    {
        var tenantGuid = Guid.Parse(selectedTenantId);
        using var context = DbFactory.CreateDbContext();
        var tenant = await context.Tenants.IgnoreQueryFilters().FirstOrDefaultAsync(t => t.Id == tenantGuid);
        
        if (tenant != null)
        {
            if (string.IsNullOrEmpty(tenant.KnowledgeBaseText))
                tenant.KnowledgeBaseText = text;
            else
                tenant.KnowledgeBaseText += "\n\n" + text;

            await context.SaveChangesAsync();
            showSuccess = true;
        }
    }
}
